# AI Engineer Rules

## Role

**AI Engineer (Lead Architect)** - проектирование и разработка AI агента для подбора туров

---

## System Rules

### Роль AI
- Архитектор AI системы
- Разработчик промптов и инструментов
- Интегратор MCP серверов
- Создатель агента для подбора туров

### Ограничения
- ❌ **Запрещено:** Использовать только GPT API без инструментов
- ✅ **Обязательно:** Использовать минимум 1 MCP или sub-agent
- ✅ **Обязательно:** AI должен вызывать tools для получения данных о турах
- ✅ **Обязательно:** Агент должен использовать реальные данные из Backend API

### Чего делать нельзя
- Не создавать агента без интеграции с MCP
- Не использовать только генерацию текста без вызова инструментов
- Не игнорировать данные из базы данных туров
- Не создавать статичные ответы без контекста

### Формат ответов
- JSON для структурированных данных о турах
- Естественный язык для общения с пользователем
- Структурированные рекомендации с обоснованием

---

## MCP & Tools

### Используемые MCP серверы:

#### 1. Context7 MCP (приоритет)
- **Назначение:** Управление контекстом диалога и памятью агента
- **Использование:** 
  - Запоминание предпочтений пользователя (бюджет, даты, страна)
  - История предыдущих запросов
  - Контекст текущего диалога
- **Реализация:** Использует `@modelcontextprotocol/sdk` для подключения

#### 2. Database MCP
- **Назначение:** Получение данных о турах из базы данных
- **Использование:**
  - Поиск туров по критериям (страна, цена, даты)
  - Получение детальной информации о туре
  - Проверка доступности туров
- **Реализация:** Интегрирован с SQLite через better-sqlite3

### Tools, которые должен вызывать AI:

1. **search_tours** - поиск туров по параметрам
2. **get_tour_details** - получение деталей тура (через sub-agent)
3. **save_user_preferences** - сохранение предпочтений пользователя
4. **get_user_history** - получение истории запросов
5. **compare_tours** - сравнение нескольких туров (через sub-agent)

---

## Subagents

### Tour Comparison Sub-agent
- **Файл:** `backend/ai-agent/features/compare-tours.js`
- **Назначение:** Специализированный агент для сравнения туров
- **Когда вызывается:** 
  - Когда пользователь запрашивает сравнение туров
  - Когда нужно показать различия между турами
  - Когда требуется детальный анализ нескольких вариантов
- **Функции:**
  - `compareTours(tours)` - сравнение массивов туров
  - `generateComparisonText(comparison)` - генерация текстового описания

### Tour Details Sub-agent
- **Файл:** `backend/ai-agent/features/tour-details.js`
- **Назначение:** Получение и форматирование детальной информации о туре
- **Когда вызывается:**
  - Когда пользователь запрашивает детали тура
  - Когда нужно показать персонализированную информацию
  - Когда требуется анализ соответствия тура предпочтениям
- **Функции:**
  - `getTourDetails(tour, preferences)` - получение деталей с персонализацией
  - `generateDetailsText(details)` - генерация текстового описания

---

## Output Contracts

### JSON формат для данных о турах:
```json
{
  "tours": [
    {
      "id": "string",
      "title": "string",
      "country": "string",
      "price": "number",
      "duration": "number",
      "dates": "string",
      "description": "string",
      "available": "boolean"
    }
  ],
  "total": "number",
  "filters_applied": {
    "country": "string",
    "price_min": "number",
    "price_max": "number",
    "dates": "string"
  }
}
```

### Формат ответа агента:
```json
{
  "message": "string - естественный ответ пользователю",
  "tours": "array - массив найденных туров",
  "recommendations": "array - рекомендации агента",
  "context": {
    "user_preferences": "object",
    "session_id": "string"
  }
}
```

### SQL запросы (для Database MCP):
- Формат: стандартный SQL
- Пример: `SELECT * FROM tours WHERE country = ? AND price <= ? AND available = true`

---

## Workflow

1. **Получение запроса пользователя** → анализ через Context7 MCP
2. **Извлечение параметров** → бюджет, даты, страна, предпочтения
3. **Поиск туров** → вызов Database MCP через search_tours tool
4. **Анализ результатов** → использование sub-agents для сравнения и деталей
5. **Генерация ответа** → естественный язык + структурированные данные
6. **Сохранение контекста** → обновление через Context7 MCP

---

## Примеры использования

### Пример 1: Поиск туров
```
User: "Хочу поехать в Японию на 10 дней, бюджет до 3000 долларов"

AI Actions:
1. Context7: сохранить предпочтения (страна: Япония, бюджет: 3000, длительность: 10)
2. Database MCP: search_tours({country: "Japan", price_max: 3000, duration: 10})
3. Context7: сохранить результаты поиска
4. Генерация ответа с рекомендациями
```

### Пример 2: Сравнение туров
```
User: "Чем отличается тур A от тура B?"

AI Actions:
1. Context7: получить сохраненные туры из контекста
2. Database MCP: get_tour_details для обоих туров
3. Sub-agent (compare-tours): сравнить туры по параметрам
4. Генерация сравнительного анализа
```

---

## Критерии успеха

- ✅ AI использует MCP для получения реальных данных
- ✅ Агент запоминает предпочтения пользователя
- ✅ Ответы персонализированы и основаны на данных
- ✅ Интеграция с Backend работает корректно
- ✅ Все вызовы tools логируются
- ✅ Sub-agents используются для специализированных задач

